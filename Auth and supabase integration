import { createClient } from "@supabase/supabase-js";

const SUPABASE_URL = process.env.SUPABASE_URL!;
const SUPABASE_ANON_KEY = process.env.SUPABASE_ANON_KEY!;

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  throw new Error("Missing SUPABASE_URL or SUPABASE_ANON_KEY env vars");
}

export function supabaseFromToken(accessToken: string) {
  // Use anon key + user token => respects RLS (recommended)
  return createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: {
      headers: {
        Authorization: `Bearer ${accessToken}`,
      },
    },
    auth: {
      persistSession: false,
      autoRefreshToken: false,
      detectSessionInUrl: false,
    },
  });
}

api/_lib/auth.ts

import type { VercelRequest } from "@vercel/node";
import { z } from "zod";
import { supabaseFromToken } from "./supabase";

const authHeaderSchema = z.string().min(10);

export async function requireUser(req: VercelRequest) {
  const authHeader = req.headers.authorization || "";
  const token = authHeader.startsWith("Bearer ")
    ? authHeader.slice("Bearer ".length)
    : "";

  authHeaderSchema.parse(token);

  const supabase = supabaseFromToken(token);
  const { data, error } = await supabase.auth.getUser();

  if (error || !data?.user) {
    throw Object.assign(new Error("Unauthorized"), { status: 401 });
  }

  return { supabase, user: data.user };
}
